<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 源码学习（五）：事件机制 | 地狱猫</title>
    <meta name="description" content="向前一小步文明一大步">
    
    
    <link rel="preload" href="/assets/css/0.styles.5b15de55.css" as="style"><link rel="preload" href="/assets/js/app.8baa1c18.js" as="script"><link rel="preload" href="/assets/js/2.c363b9ef.js" as="script"><link rel="preload" href="/assets/js/103.2d3829fa.js" as="script"><link rel="prefetch" href="/assets/js/10.b82cb7bf.js"><link rel="prefetch" href="/assets/js/100.c8fd16ce.js"><link rel="prefetch" href="/assets/js/101.c65497a1.js"><link rel="prefetch" href="/assets/js/102.1c50acd0.js"><link rel="prefetch" href="/assets/js/104.f6530161.js"><link rel="prefetch" href="/assets/js/105.e2d7d4ae.js"><link rel="prefetch" href="/assets/js/106.a9b6a793.js"><link rel="prefetch" href="/assets/js/107.9e673e79.js"><link rel="prefetch" href="/assets/js/108.ffd6b797.js"><link rel="prefetch" href="/assets/js/109.f3a087da.js"><link rel="prefetch" href="/assets/js/11.50040078.js"><link rel="prefetch" href="/assets/js/110.6637ef3a.js"><link rel="prefetch" href="/assets/js/111.d38fca98.js"><link rel="prefetch" href="/assets/js/112.b60db543.js"><link rel="prefetch" href="/assets/js/113.200a573a.js"><link rel="prefetch" href="/assets/js/114.d3c96553.js"><link rel="prefetch" href="/assets/js/115.6deda451.js"><link rel="prefetch" href="/assets/js/116.260f763f.js"><link rel="prefetch" href="/assets/js/117.72244e33.js"><link rel="prefetch" href="/assets/js/118.cb63b3a4.js"><link rel="prefetch" href="/assets/js/119.88a7979b.js"><link rel="prefetch" href="/assets/js/12.ee2aef2f.js"><link rel="prefetch" href="/assets/js/120.1e71300a.js"><link rel="prefetch" href="/assets/js/121.b9d5d01f.js"><link rel="prefetch" href="/assets/js/122.fa3a2b3c.js"><link rel="prefetch" href="/assets/js/123.18b52755.js"><link rel="prefetch" href="/assets/js/124.22dae44e.js"><link rel="prefetch" href="/assets/js/125.6f693785.js"><link rel="prefetch" href="/assets/js/126.9979d92e.js"><link rel="prefetch" href="/assets/js/127.97129415.js"><link rel="prefetch" href="/assets/js/128.201a3af5.js"><link rel="prefetch" href="/assets/js/129.02f6ced5.js"><link rel="prefetch" href="/assets/js/13.9ba3b7b3.js"><link rel="prefetch" href="/assets/js/130.a2809baf.js"><link rel="prefetch" href="/assets/js/14.8387646c.js"><link rel="prefetch" href="/assets/js/15.9053ef96.js"><link rel="prefetch" href="/assets/js/16.885fad55.js"><link rel="prefetch" href="/assets/js/17.3e595d76.js"><link rel="prefetch" href="/assets/js/18.d2db4c3a.js"><link rel="prefetch" href="/assets/js/19.693475f3.js"><link rel="prefetch" href="/assets/js/20.7657adef.js"><link rel="prefetch" href="/assets/js/21.9db66cb8.js"><link rel="prefetch" href="/assets/js/22.017b8ee6.js"><link rel="prefetch" href="/assets/js/23.e3d63843.js"><link rel="prefetch" href="/assets/js/24.778b9842.js"><link rel="prefetch" href="/assets/js/25.9db9c6a8.js"><link rel="prefetch" href="/assets/js/26.a1464114.js"><link rel="prefetch" href="/assets/js/27.005c669a.js"><link rel="prefetch" href="/assets/js/28.83ba67aa.js"><link rel="prefetch" href="/assets/js/29.3b5d9158.js"><link rel="prefetch" href="/assets/js/3.55fc7466.js"><link rel="prefetch" href="/assets/js/30.27602bf8.js"><link rel="prefetch" href="/assets/js/31.30b968a7.js"><link rel="prefetch" href="/assets/js/32.c5c32adc.js"><link rel="prefetch" href="/assets/js/33.28363357.js"><link rel="prefetch" href="/assets/js/34.d934db23.js"><link rel="prefetch" href="/assets/js/35.d317a407.js"><link rel="prefetch" href="/assets/js/36.c34064e0.js"><link rel="prefetch" href="/assets/js/37.d0122ae3.js"><link rel="prefetch" href="/assets/js/38.3897eeb2.js"><link rel="prefetch" href="/assets/js/39.fa564859.js"><link rel="prefetch" href="/assets/js/4.a18312b1.js"><link rel="prefetch" href="/assets/js/40.18195e4e.js"><link rel="prefetch" href="/assets/js/41.1e09a7ba.js"><link rel="prefetch" href="/assets/js/42.7005f709.js"><link rel="prefetch" href="/assets/js/43.80deb814.js"><link rel="prefetch" href="/assets/js/44.c464426d.js"><link rel="prefetch" href="/assets/js/45.b1d17d7a.js"><link rel="prefetch" href="/assets/js/46.e3a0a71a.js"><link rel="prefetch" href="/assets/js/47.5ca1b2a7.js"><link rel="prefetch" href="/assets/js/48.2c96008f.js"><link rel="prefetch" href="/assets/js/49.ce2015c8.js"><link rel="prefetch" href="/assets/js/5.98f0c28f.js"><link rel="prefetch" href="/assets/js/50.69399a6d.js"><link rel="prefetch" href="/assets/js/51.6fe3216a.js"><link rel="prefetch" href="/assets/js/52.ce3e04da.js"><link rel="prefetch" href="/assets/js/53.66c0b531.js"><link rel="prefetch" href="/assets/js/54.e7a6dc85.js"><link rel="prefetch" href="/assets/js/55.67fd71ea.js"><link rel="prefetch" href="/assets/js/56.5805ea45.js"><link rel="prefetch" href="/assets/js/57.51edec73.js"><link rel="prefetch" href="/assets/js/58.dadcc0bf.js"><link rel="prefetch" href="/assets/js/59.f2ee4962.js"><link rel="prefetch" href="/assets/js/6.9d21f84a.js"><link rel="prefetch" href="/assets/js/60.8653fa8c.js"><link rel="prefetch" href="/assets/js/61.8f632334.js"><link rel="prefetch" href="/assets/js/62.ebc3d94b.js"><link rel="prefetch" href="/assets/js/63.734529fa.js"><link rel="prefetch" href="/assets/js/64.dc7d9ed8.js"><link rel="prefetch" href="/assets/js/65.3a073543.js"><link rel="prefetch" href="/assets/js/66.0766faee.js"><link rel="prefetch" href="/assets/js/67.ae00c912.js"><link rel="prefetch" href="/assets/js/68.5309c10b.js"><link rel="prefetch" href="/assets/js/69.d6e79a9b.js"><link rel="prefetch" href="/assets/js/7.c1707ee3.js"><link rel="prefetch" href="/assets/js/70.09c653a2.js"><link rel="prefetch" href="/assets/js/71.0791c1ec.js"><link rel="prefetch" href="/assets/js/72.7fbb5123.js"><link rel="prefetch" href="/assets/js/73.264558f2.js"><link rel="prefetch" href="/assets/js/74.24fb5137.js"><link rel="prefetch" href="/assets/js/75.cb924dd1.js"><link rel="prefetch" href="/assets/js/76.5be6dad8.js"><link rel="prefetch" href="/assets/js/77.d293358a.js"><link rel="prefetch" href="/assets/js/78.a5ba6da1.js"><link rel="prefetch" href="/assets/js/79.7fbb902d.js"><link rel="prefetch" href="/assets/js/8.88da2a38.js"><link rel="prefetch" href="/assets/js/80.265fcf49.js"><link rel="prefetch" href="/assets/js/81.5cbf3d53.js"><link rel="prefetch" href="/assets/js/82.61e1168d.js"><link rel="prefetch" href="/assets/js/83.c957da9f.js"><link rel="prefetch" href="/assets/js/84.3363c030.js"><link rel="prefetch" href="/assets/js/85.c1802988.js"><link rel="prefetch" href="/assets/js/86.f97efcad.js"><link rel="prefetch" href="/assets/js/87.a4258d3f.js"><link rel="prefetch" href="/assets/js/88.310decb4.js"><link rel="prefetch" href="/assets/js/89.673a6248.js"><link rel="prefetch" href="/assets/js/9.8f0f74e4.js"><link rel="prefetch" href="/assets/js/90.4ae7e5ea.js"><link rel="prefetch" href="/assets/js/91.75feaf6e.js"><link rel="prefetch" href="/assets/js/92.059ca332.js"><link rel="prefetch" href="/assets/js/93.439369e5.js"><link rel="prefetch" href="/assets/js/94.36ddb701.js"><link rel="prefetch" href="/assets/js/95.642311f2.js"><link rel="prefetch" href="/assets/js/96.1ecb484a.js"><link rel="prefetch" href="/assets/js/97.bcdbc3fb.js"><link rel="prefetch" href="/assets/js/98.d4f0cc28.js"><link rel="prefetch" href="/assets/js/99.a7b2f6b6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5b15de55.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">地狱猫</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/webpack/基础篇.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/react/" class="nav-link router-link-active">react</a></div><div class="nav-item"><a href="/css/规范.html" class="nav-link">css</a></div><div class="nav-item"><a href="/day/a标签href不能下载图片.html" class="nav-link">日常</a></div><div class="nav-item"><a href="/tool/emoij美化你的commitlog.html" class="nav-link">工具</a></div><div class="nav-item"><a href="/accumulate/jserror.html" class="nav-link">积累</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/datastruct/" class="nav-link">数据结构</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/webpack/基础篇.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/react/" class="nav-link router-link-active">react</a></div><div class="nav-item"><a href="/css/规范.html" class="nav-link">css</a></div><div class="nav-item"><a href="/day/a标签href不能下载图片.html" class="nav-link">日常</a></div><div class="nav-item"><a href="/tool/emoij美化你的commitlog.html" class="nav-link">工具</a></div><div class="nav-item"><a href="/accumulate/jserror.html" class="nav-link">积累</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/datastruct/" class="nav-link">数据结构</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/react/React-01.html" class="sidebar-link">React 源码学习（一）：HTML 元素渲染</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>阅读源码成了今年的学习目标之一，在选择 Vue 和 React 之间，我想先阅读 React 。
在考虑到读哪个版本的时候，我想先接触到源码早期的思想可能会更轻松一些，最终我选择阅读 <code>0.3-stable</code> 。
那么接下来，我将从几个方面来解读这个版本的源码。</p></blockquote> <ol><li><a href="https://zongzi531.com/2019/04/01/LSC-React-01/" target="_blank" rel="noopener noreferrer">React 源码学习（一）：HTML 元素渲染<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/04/02/LSC-React-02/" target="_blank" rel="noopener noreferrer">React 源码学习（二）：HTML 子元素渲染<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/04/03/LSC-React-03/" target="_blank" rel="noopener noreferrer">React 源码学习（三）：CSS 样式及 DOM 属性<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/04/04/LSC-React-04/" target="_blank" rel="noopener noreferrer">React 源码学习（四）：事务机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/04/05/LSC-React-05/" target="_blank" rel="noopener noreferrer">React 源码学习（五）：事件机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/04/06/LSC-React-06/" target="_blank" rel="noopener noreferrer">React 源码学习（六）：组件渲染<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/04/07/LSC-React-07/" target="_blank" rel="noopener noreferrer">React 源码学习（七）：生命周期<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/04/08/LSC-React-08/" target="_blank" rel="noopener noreferrer">React 源码学习（八）：组件更新<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/12/18/LSC-React-09/" target="_blank" rel="noopener noreferrer">React 源码学习（九）：“脱胎换骨”<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/12/19/LSC-React-10/" target="_blank" rel="noopener noreferrer">React 源码学习（十）：Fiber<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/12/20/LSC-React-11/" target="_blank" rel="noopener noreferrer">React 源码学习（十一）：Scheduling<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zongzi531.com/2019/12/21/LSC-React-12/" target="_blank" rel="noopener noreferrer">React 源码学习（十二）：Reconciliation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol> <h2 id="react-事件"><a href="#react-事件" aria-hidden="true" class="header-anchor">#</a> React 事件</h2> <p>我们先来看到整体逻辑图：</p> <p><img src="05-01.png" alt="事件机制"></p> <p>React 采用将事件挂载至 <code>document</code> 或者 <code>window</code> 上来实现顶级事件。接下来我们会一一来介绍事件的实现过程。</p> <h3 id="事件插件注入"><a href="#事件插件注入" aria-hidden="true" class="header-anchor">#</a> 事件插件注入</h3> <p>我们来回忆下， <code>ReactNativeComponent.js</code> 中 <code>_createOpenTagMarkup</code> 方法中的 <code>putListener</code> 函数和 <code>ReactMount.js</code> 中 <code>renderComponent</code> 方法中的 <code>prepareTopLevelEvents</code> 函数都是事件相关的方法，前者是生成 HTML 标记时，对符合要求的“键”进行注册事件，后者则是在执行 <code>React.renderComponent</code> 方法时进行准备顶级事件的过程。当然之前有一个内容没有提到，就是在 React 注入时，默认注入了事件插件排序顺序、实例操作函数、事件插件。那让我们直接先看到代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// core/ReactDefaultInjection.js</span>
<span class="token keyword">function</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 注入模块，用于解析DOM层次结构和插件排序。</span>
  <span class="token comment">// 这里是注入事件插件排序顺序</span>
  EventPluginHub<span class="token punctuation">.</span>injection<span class="token punctuation">.</span><span class="token function">injectEventPluginOrder</span><span class="token punctuation">(</span>DefaultEventPluginOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注入实例操作函数，用于事件传播</span>
  EventPluginHub<span class="token punctuation">.</span>injection<span class="token punctuation">.</span><span class="token function">injectInstanceHandle</span><span class="token punctuation">(</span>ReactInstanceHandles<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 默认包含两个重要事件插件（而不必要求他们）。</span>
  <span class="token comment">// 注入事件插件</span>
  EventPluginHub<span class="token punctuation">.</span>injection<span class="token punctuation">.</span><span class="token function">injectEventPluginsByName</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'SimpleEventPlugin'</span><span class="token punctuation">:</span> SimpleEventPlugin<span class="token punctuation">,</span>
    <span class="token string">'EnterLeaveEventPlugin'</span><span class="token punctuation">:</span> EnterLeaveEventPlugin
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 用于兼容 IE8 创建的复合组件，后续讲到组件的时候再做解读，但不对 `ReactDOMForm.js` 进行解读</span>
  ReactDOM<span class="token punctuation">.</span>injection<span class="token punctuation">.</span><span class="token function">injectComponentClasses</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    form<span class="token punctuation">:</span> ReactDOMForm
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>当然你需要知道，这个 <code>inject</code> 函数时需要在 <code>React.js</code> 中引入并执行的。</p> <p>我们一步步往下看。先来看看 <code>DefaultEventPluginOrder.js</code> ：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// eventPlugins/DefaultEventPluginOrder.js</span>
<span class="token keyword">var</span> DefaultEventPluginOrder <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">keyOf</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ResponderEventPlugin<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">keyOf</span><span class="token punctuation">(</span><span class="token punctuation">{</span>SimpleEventPlugin<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">keyOf</span><span class="token punctuation">(</span><span class="token punctuation">{</span>TapEventPlugin<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">keyOf</span><span class="token punctuation">(</span><span class="token punctuation">{</span>EnterLeaveEventPlugin<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">keyOf</span><span class="token punctuation">(</span><span class="token punctuation">{</span>AnalyticsEventPlugin<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>就是一个事件插件的默认顺序列表，使用 <code>EventPluginHub.injection.injectEventPluginOrder</code> 方法进行注入。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// event/EventPluginHub.js</span>
<span class="token keyword">var</span> injection <span class="token operator">=</span> <span class="token punctuation">{</span>
  EventPluginOrder<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token function-variable function">injectEventPluginOrder</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">InjectedEventPluginOrder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    injection<span class="token punctuation">.</span>EventPluginOrder <span class="token operator">=</span> InjectedEventPluginOrder<span class="token punctuation">;</span>
    <span class="token comment">// 这个方法稍后再做解读，因为 injectEventPluginsByName 方法也使用到了他</span>
    injection<span class="token punctuation">.</span><span class="token function">_recomputePluginsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>EventPluginHub.injection.injectInstanceHandle(ReactInstanceHandles);</code> 也是差不多的操作，他操作的是 <code>EventPropagators.js</code> 下的 <code>InstanceHandle</code> 。 <code>ReactInstanceHandles</code> 在后续事件相关中都会使用到。我们先来看看 <code>injectEventPluginsByName</code> 方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// event/EventPluginHub.js</span>
<span class="token keyword">var</span> injection <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">injectEventPluginsByName</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">pluginsByName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里讲传入插件与已存插件进行合并</span>
    injection<span class="token punctuation">.</span>pluginsByName <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>injection<span class="token punctuation">.</span>pluginsByName<span class="token punctuation">,</span> pluginsByName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    injection<span class="token punctuation">.</span><span class="token function">_recomputePluginsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  pluginsByName<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 重新计算事件插件顺序列表</span>
  <span class="token function-variable function">_recomputePluginsList</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token function-variable function">injectPluginByName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> PluginModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 查找插件顺序列表，不存在则抛出错误</span>
      <span class="token keyword">var</span> pluginIndex <span class="token operator">=</span> injection<span class="token punctuation">.</span>EventPluginOrder<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">throwIf</span><span class="token punctuation">(</span>pluginIndex <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">ERRORS</span><span class="token punctuation">.</span><span class="token constant">DEPENDENCY_ERROR</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 对应的插件列表不存在的情况，则在对应索引赋值其对应的插件模块</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>injection<span class="token punctuation">.</span>plugins<span class="token punctuation">[</span>pluginIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        injection<span class="token punctuation">.</span>plugins<span class="token punctuation">[</span>pluginIndex<span class="token punctuation">]</span> <span class="token operator">=</span> PluginModule<span class="token punctuation">;</span>
        <span class="token comment">// 遍历其插件模块对应的抽象事件类型</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> eventName <span class="token keyword">in</span> PluginModule<span class="token punctuation">.</span>abstractEventTypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> eventType <span class="token operator">=</span> PluginModule<span class="token punctuation">.</span>abstractEventTypes<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">// 记录所有的注册名称</span>
          <span class="token function">recordAllRegistrationNames</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> PluginModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 事件插件的默认顺序列表存在情况</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>injection<span class="token punctuation">.</span>EventPluginOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Else, do when plugin order injected</span>
      <span class="token keyword">var</span> injectedPluginsByName <span class="token operator">=</span> injection<span class="token punctuation">.</span>pluginsByName<span class="token punctuation">;</span>
      <span class="token comment">// 遍历注入的插件</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> name <span class="token keyword">in</span> injectedPluginsByName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">injectPluginByName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> injectedPluginsByName<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> registrationNames <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> registrationNamesArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">recordAllRegistrationNames</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> PluginModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> phaseName<span class="token punctuation">;</span>
  <span class="token comment">// 从 eventType 获得 phasedRegistrationNames</span>
  <span class="token keyword">var</span> phasedRegistrationNames <span class="token operator">=</span> eventType<span class="token punctuation">.</span>phasedRegistrationNames<span class="token punctuation">;</span>
  <span class="token comment">// 查看相关源码可以发现，这里适用于 `SimpleEventPlugin`</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>phasedRegistrationNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历 phasedRegistrationNames</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>phaseName <span class="token keyword">in</span> phasedRegistrationNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>phasedRegistrationNames<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>phaseName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 对应位置进行添加</span>
      registrationNames<span class="token punctuation">[</span>phasedRegistrationNames<span class="token punctuation">[</span>phaseName<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> PluginModule<span class="token punctuation">;</span>
      registrationNamesArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>phasedRegistrationNames<span class="token punctuation">[</span>phaseName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>eventType<span class="token punctuation">.</span>registrationName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 若注册名称在的情况，查看相关源码可以发现，这里适用于 `EnterLeaveEventPlugin`</span>
    registrationNames<span class="token punctuation">[</span>eventType<span class="token punctuation">.</span>registrationName<span class="token punctuation">]</span> <span class="token operator">=</span> PluginModule<span class="token punctuation">;</span>
    registrationNamesArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>eventType<span class="token punctuation">.</span>registrationName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 看到源码项目结构或者事件插件的默认顺序列表你都会发现，有着 `ResponderEventPlugin`</span>
  <span class="token comment">// `TapEventPlugin`, `AnalyticsEventPlugin` 的存在。</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>比较抽象对吧，因为这里操作的都是事件插件的默认顺序列表中的对象，我们接下来看到 <code>SimpleEventPlugin</code> 和 <code>EnterLeaveEventPlugin</code> 来做相应的解释：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// eventPlugins/SimpleEventPlugin.js</span>
<span class="token keyword">var</span> SimpleEventPlugin <span class="token operator">=</span> <span class="token punctuation">{</span>
  abstractEventTypes<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Note: We do not allow listening to mouseOver events. Instead, use the</span>
    <span class="token comment">// onMouseEnter/onMouseLeave created by `EnterLeaveEventPlugin`.</span>
    <span class="token comment">// 这里提到 onMouseEnter/onMouseLeave 请查看到 `EnterLeaveEventPlugin.js`</span>
    mouseDown<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这是上面注册所有事件名称使用到的位置</span>
      phasedRegistrationNames<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        bubbled<span class="token punctuation">:</span> <span class="token function">keyOf</span><span class="token punctuation">(</span><span class="token punctuation">{</span>onMouseDown<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        captured<span class="token punctuation">:</span> <span class="token function">keyOf</span><span class="token punctuation">(</span><span class="token punctuation">{</span>onMouseDownCapture<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// eventPlugins/EnterLeaveEventPlugin.js</span>
<span class="token keyword">var</span> abstractEventTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
  mouseEnter<span class="token punctuation">:</span> <span class="token punctuation">{</span>registrationName<span class="token punctuation">:</span> <span class="token function">keyOf</span><span class="token punctuation">(</span><span class="token punctuation">{</span>onMouseEnter<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  mouseLeave<span class="token punctuation">:</span> <span class="token punctuation">{</span>registrationName<span class="token punctuation">:</span> <span class="token function">keyOf</span><span class="token punctuation">(</span><span class="token punctuation">{</span>onMouseLeave<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>那么从中获取相应的对象如 <code>phasedRegistrationNames</code> 或是对应的标识 <code>registrationName</code>。</p> <h2 id="注册顶级事件"><a href="#注册顶级事件" aria-hidden="true" class="header-anchor">#</a> 注册顶级事件</h2> <p>我们现在来看到 <code>ReactMount.js</code> 中 <code>renderComponent</code> 方法中的 <code>prepareTopLevelEvents</code> 函数：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// core/ReactMount.js</span>
<span class="token keyword">var</span> ReactMount <span class="token operator">=</span> <span class="token punctuation">{</span>
  useTouchEvents<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token function-variable function">prepareTopLevelEvents</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">TopLevelCallbackCreator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ReactEvent<span class="token punctuation">.</span><span class="token function">ensureListening</span><span class="token punctuation">(</span>
      <span class="token comment">// 用于控制是否使用 TouchEvents ， 默认为 false</span>
      ReactMount<span class="token punctuation">.</span>useTouchEvents<span class="token punctuation">,</span>
      TopLevelCallbackCreator
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>但是你可以调用 <code>React.initializeTouchEvents(true);</code> 来提前开启他，当然这是你需要使用到他的时候。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// core/ReactEvent.js</span>
<span class="token keyword">var</span> _isListening <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">ensureListening</span><span class="token punctuation">(</span><span class="token parameter">touchNotMouse<span class="token punctuation">,</span> TopLevelCallbackCreator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isListening<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 赋值顶级回调创建者</span>
    ReactEvent<span class="token punctuation">.</span>TopLevelCallbackCreator <span class="token operator">=</span> TopLevelCallbackCreator<span class="token punctuation">;</span>
    <span class="token function">listenAtTopLevel</span><span class="token punctuation">(</span>touchNotMouse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 一个私有变量，用于控制 ensureListening 方法只执行一次</span>
    _isListening <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">listenAtTopLevel</span><span class="token punctuation">(</span><span class="token parameter">touchNotMouse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> mountAt <span class="token operator">=</span> document<span class="token punctuation">;</span>

  <span class="token function">registerDocumentScrollListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">registerDocumentResizeListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">trapBubbledEvent</span><span class="token punctuation">(</span>topLevelTypes<span class="token punctuation">.</span>topMouseOver<span class="token punctuation">,</span> <span class="token string">'mouseover'</span><span class="token punctuation">,</span> mountAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// TouchEvents 相关</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>touchNotMouse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trapBubbledEvent</span><span class="token punctuation">(</span>topLevelTypes<span class="token punctuation">.</span>topTouchStart<span class="token punctuation">,</span> <span class="token string">'touchstart'</span><span class="token punctuation">,</span> mountAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ... 以及一些兼容相关，涉及使用到 `isEventSupported` 方法</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// event/EventConstants.js</span>
<span class="token keyword">var</span> topLevelTypes <span class="token operator">=</span> <span class="token function">keyMirror</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  topBlur<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="捕获-冒泡事件监听"><a href="#捕获-冒泡事件监听" aria-hidden="true" class="header-anchor">#</a> 捕获/冒泡事件监听</h3> <p>上面代码直接完成顶级事件的监听，我们顺势来看看 <code>trapBubbledEvent</code> ，与之相关的还有 <code>trapCapturedEvent</code> ，分别是冒泡和捕获阶段：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// core/ReactEvent.js</span>
<span class="token keyword">function</span> <span class="token function">trapBubbledEvent</span><span class="token punctuation">(</span><span class="token parameter">topLevelType<span class="token punctuation">,</span> handlerBaseName<span class="token punctuation">,</span> onWhat</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">listen</span><span class="token punctuation">(</span>
    onWhat<span class="token punctuation">,</span>
    handlerBaseName<span class="token punctuation">,</span>
    ReactEvent<span class="token punctuation">.</span>TopLevelCallbackCreator<span class="token punctuation">.</span><span class="token function">createTopLevelCallback</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">trapCapturedEvent</span><span class="token punctuation">(</span><span class="token parameter">topLevelType<span class="token punctuation">,</span> handlerBaseName<span class="token punctuation">,</span> onWhat</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">capture</span><span class="token punctuation">(</span>
    onWhat<span class="token punctuation">,</span>
    handlerBaseName<span class="token punctuation">,</span>
    ReactEvent<span class="token punctuation">.</span>TopLevelCallbackCreator<span class="token punctuation">.</span><span class="token function">createTopLevelCallback</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>其实从这里你就可以发现，不管是冒泡或者是捕获，我在 <code>document</code> 或者 <code>window</code> 这样的顶级对象上，都会先被捕获到，至于最后想到哪个方法或者函数，那么是由事件传播器控制，查找对应的回调注册表来完成功能。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// event/NormalizedEventListener.js</span>
<span class="token keyword">function</span> <span class="token function">createNormalizedCallback</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">unfixedNativeEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token function">normalizeEvent</span><span class="token punctuation">(</span>unfixedNativeEvent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> NormalizedEventListener <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">listen</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> handlerBaseName<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    EventListener<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> handlerBaseName<span class="token punctuation">,</span> <span class="token function">createNormalizedCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">capture</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> handlerBaseName<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    EventListener<span class="token punctuation">.</span><span class="token function">capture</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> handlerBaseName<span class="token punctuation">,</span> <span class="token function">createNormalizedCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>normalizeEvent</code> 函数是一个补丁，这里不做解读。你可以直接忽略理解为 <code>cb(unfixedNativeEvent);</code> 。这里调用的又是另一个模块 <code>EventListener</code> ， <code>EventListener</code> 则的对原生浏览器 API 进行了封装。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// vendor/stubs/EventListener.js</span>
<span class="token keyword">var</span> EventListener <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">listen</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> handlerBaseName<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>handlerBaseName<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>attachEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">'on'</span> <span class="token operator">+</span> handlerBaseName<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">capture</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> handlerBaseName<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>handlerBaseName<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="react-顶级事件回调方法"><a href="#react-顶级事件回调方法" aria-hidden="true" class="header-anchor">#</a> React 顶级事件回调方法</h2> <p>那么由此可以看出， <code>trapBubbledEvent</code> 在操作的其实就是 <code>addEventListener</code> API，唯独还没有解读的是 <code>ReactEvent.TopLevelCallbackCreator.createTopLevelCallback(topLevelType)</code> ，其实你会发现，从刚刚开始我都没有解读 <code>TopLevelCallbackCreator</code> ，那么我们现在就来聊聊：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// core/ReactEventTopLevelCallback.js</span>
<span class="token keyword">var</span> ReactEventTopLevelCallback <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里的 `topLevelType` 的值已经在 `listenAtTopLevel` 函数执行阶段就完成了赋值</span>
  <span class="token comment">// 当 `addEventListener` 执行后，返回的是 `unfixedNativeEvent` 参数</span>
  <span class="token comment">// 经过由 `normalizeEvent` 补丁处理后，返回 `fixedNativeEvent`</span>
  <span class="token function-variable function">createTopLevelCallback</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">topLevelType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fixedNativeEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这个在之前也有提到过，当执行 React 调度事务时，将控制事件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_topLevelListenersEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 获得第一个 React DOM</span>
      <span class="token keyword">var</span> renderedTarget <span class="token operator">=</span> ReactInstanceHandles<span class="token punctuation">.</span><span class="token function">getFirstReactDOM</span><span class="token punctuation">(</span>
        fixedNativeEvent<span class="token punctuation">.</span>target
      <span class="token punctuation">)</span> <span class="token operator">||</span> ExecutionEnvironment<span class="token punctuation">.</span>global<span class="token punctuation">;</span>
      <span class="token comment">// 获得对应的 ID</span>
      <span class="token keyword">var</span> renderedTargetID <span class="token operator">=</span> <span class="token function">getDOMNodeID</span><span class="token punctuation">(</span>renderedTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> event <span class="token operator">=</span> fixedNativeEvent<span class="token punctuation">;</span>
      <span class="token keyword">var</span> target <span class="token operator">=</span> renderedTarget<span class="token punctuation">;</span>
      <span class="token comment">// 例如： ReactEvent.handleTopLevel('topClick', event, '.reactRoot[0]', target)</span>
      ReactEvent<span class="token punctuation">.</span><span class="token function">handleTopLevel</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">,</span> event<span class="token punctuation">,</span> renderedTargetID<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="创建抽象事件及执行至销毁"><a href="#创建抽象事件及执行至销毁" aria-hidden="true" class="header-anchor">#</a> 创建抽象事件及执行至销毁</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// core/ReactEvent.js</span>
<span class="token keyword">function</span> <span class="token function">handleTopLevel</span><span class="token punctuation">(</span>
    <span class="token parameter">topLevelType<span class="token punctuation">,</span>
    nativeEvent<span class="token punctuation">,</span>
    renderedTargetID<span class="token punctuation">,</span>
    renderedTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 提取抽象事件，返回 AbstractEvents 实例</span>
  <span class="token comment">// 这个抽象事件可能是 AbstractEvents 或者可能是 AbstractEvents[]</span>
  <span class="token keyword">var</span> abstractEvents <span class="token operator">=</span> EventPluginHub<span class="token punctuation">.</span><span class="token function">extractAbstractEvents</span><span class="token punctuation">(</span>
    topLevelType<span class="token punctuation">,</span>
    nativeEvent<span class="token punctuation">,</span>
    renderedTargetID<span class="token punctuation">,</span>
    renderedTarget
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The event queue being processed in the same cycle allows preventDefault.</span>
  <span class="token comment">// 加入抽象事件队列</span>
  EventPluginHub<span class="token punctuation">.</span><span class="token function">enqueueAbstractEvents</span><span class="token punctuation">(</span>abstractEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  EventPluginHub<span class="token punctuation">.</span><span class="token function">processAbstractEventQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// event/EventPluginHub.js</span>
<span class="token keyword">var</span> <span class="token function-variable function">extractAbstractEvents</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">topLevelType<span class="token punctuation">,</span> nativeEvent<span class="token punctuation">,</span> renderedTargetID<span class="token punctuation">,</span> renderedTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> abstractEvents<span class="token punctuation">;</span>
  <span class="token comment">// 重新计算的 plugins 列表，就是执行 _recomputePluginsList 函数后的结果</span>
  <span class="token keyword">var</span> plugins <span class="token operator">=</span> injection<span class="token punctuation">.</span>plugins<span class="token punctuation">;</span>
  <span class="token keyword">var</span> len <span class="token operator">=</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token comment">// 遍历插件列表</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Not every plugin in the ordering may be loaded at runtime.</span>
    <span class="token keyword">var</span> possiblePlugin <span class="token operator">=</span> plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// possiblePlugin 存在的情况下执行</span>
    <span class="token comment">// 这里的 extractAbstractEvents 方法是 possiblePlugin 的</span>
    <span class="token comment">// 比如 SimpleEventPlugin.extractAbstractEvents 方法</span>
    <span class="token comment">// 对 SimpleEventPlugin.extractAbstractEvents 或者是 EnterLeaveEventPlugin.extractAbstractEvents</span>
    <span class="token comment">// 这里不做具体解读，但是需要提到的是，进过函数返回的内容是 AbstractEvent 的实例，他使用 PooledClass 注入过</span>
    <span class="token comment">// 可以直接调用 getPooled 及 release 方法</span>
    <span class="token keyword">var</span> extractedAbstractEvents <span class="token operator">=</span>
      possiblePlugin <span class="token operator">&amp;&amp;</span>
      possiblePlugin<span class="token punctuation">.</span><span class="token function">extractAbstractEvents</span><span class="token punctuation">(</span>
        topLevelType<span class="token punctuation">,</span>
        nativeEvent<span class="token punctuation">,</span>
        renderedTargetID<span class="token punctuation">,</span>
        renderedTarget
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 若最终这个返回值存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>extractedAbstractEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 合并 abstractEvents 和 extractedAbstractEvents</span>
      abstractEvents <span class="token operator">=</span> <span class="token function">accumulate</span><span class="token punctuation">(</span>abstractEvents<span class="token punctuation">,</span> extractedAbstractEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> abstractEvents<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> abstractEventQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">enqueueAbstractEvents</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">abstractEvents</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>abstractEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对这个抽象事件队列进行合并</span>
    abstractEventQueue <span class="token operator">=</span> <span class="token function">accumulate</span><span class="token punctuation">(</span>abstractEventQueue<span class="token punctuation">,</span> abstractEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">processAbstractEventQueue</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> processingAbstractEventQueue <span class="token operator">=</span> abstractEventQueue<span class="token punctuation">;</span>
  <span class="token comment">// 释放内存</span>
  abstractEventQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 若 processingAbstractEventQueue 是数组则遍历执行 executeDispatchesAndRelease 函数</span>
  <span class="token comment">// 反之 executeDispatchesAndRelease(processingAbstractEventQueue)</span>
  <span class="token function">forEachAccumulated</span><span class="token punctuation">(</span>processingAbstractEventQueue<span class="token punctuation">,</span> executeDispatchesAndRelease<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">executeDispatchesAndRelease</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">abstractEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>abstractEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获得对应的注册事件名称</span>
    <span class="token keyword">var</span> PluginModule <span class="token operator">=</span> <span class="token function">getPluginModuleForAbstractEvent</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 比如获得了 SimpleEventPlugin.executeDispatch ，用于实现与默认实现相同，但在返回值为 false 时取消事件除外的功能</span>
    <span class="token keyword">var</span> pluginExecuteDispatch <span class="token operator">=</span> PluginModule <span class="token operator">&amp;&amp;</span> PluginModule<span class="token punctuation">.</span>executeDispatch<span class="token punctuation">;</span>
    EventPluginUtils<span class="token punctuation">.</span><span class="token function">executeDispatchesInOrder</span><span class="token punctuation">(</span>
      abstractEvent<span class="token punctuation">,</span>
      pluginExecuteDispatch <span class="token operator">||</span> EventPluginUtils<span class="token punctuation">.</span>executeDispatch
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 销毁抽象事件</span>
    AbstractEvent<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getPluginModuleForAbstractEvent</span><span class="token punctuation">(</span><span class="token parameter">abstractEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>abstractEvent<span class="token punctuation">.</span>type<span class="token punctuation">.</span>registrationName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> registrationNames<span class="token punctuation">[</span>abstractEvent<span class="token punctuation">.</span>type<span class="token punctuation">.</span>registrationName<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> phase <span class="token keyword">in</span> abstractEvent<span class="token punctuation">.</span>type<span class="token punctuation">.</span>phasedRegistrationNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>abstractEvent<span class="token punctuation">.</span>type<span class="token punctuation">.</span>phasedRegistrationNames<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>phase<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> PluginModule <span class="token operator">=</span> registrationNames<span class="token punctuation">[</span>
        abstractEvent<span class="token punctuation">.</span>type<span class="token punctuation">.</span>phasedRegistrationNames<span class="token punctuation">[</span>phase<span class="token punctuation">]</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>PluginModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> PluginModule<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><h3 id="实例化抽象事件"><a href="#实例化抽象事件" aria-hidden="true" class="header-anchor">#</a> 实例化抽象事件</h3> <p>这里将对 <code>SimpleEventPlugin.extractAbstractEvents</code> 或者是 <code>EnterLeaveEventPlugin.extractAbstractEvents</code> 进行解读。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// eventPlugins/SimpleEventPlugin.js</span>
<span class="token keyword">var</span> SimpleEventPlugin <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 'topClick', event, '.reactRoot[0]', target</span>
  <span class="token function-variable function">extractAbstractEvents</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">topLevelType<span class="token punctuation">,</span> nativeEvent<span class="token punctuation">,</span> renderedTargetID<span class="token punctuation">,</span> renderedTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> data<span class="token punctuation">;</span>
    <span class="token comment">// SimpleEventPlugin.abstractEventTypes 的映射</span>
    <span class="token keyword">var</span> abstractEventType <span class="token operator">=</span>
      SimpleEventPlugin<span class="token punctuation">.</span>topLevelTypesToAbstract<span class="token punctuation">[</span>topLevelType<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>abstractEventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 实例化 AbstractEvent</span>
    <span class="token keyword">var</span> abstractEvent <span class="token operator">=</span> AbstractEvent<span class="token punctuation">.</span><span class="token function">getPooled</span><span class="token punctuation">(</span>
      abstractEventType<span class="token punctuation">,</span>
      renderedTargetID<span class="token punctuation">,</span>
      topLevelType<span class="token punctuation">,</span>
      nativeEvent<span class="token punctuation">,</span>
      data
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里是个关键</span>
    <span class="token comment">// 对捕获和冒泡分别进行派发这个 AbstractEvent 实例</span>
    EventPropagators<span class="token punctuation">.</span><span class="token function">accumulateTwoPhaseDispatches</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> abstractEvent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

SimpleEventPlugin<span class="token punctuation">.</span>topLevelTypesToAbstract <span class="token operator">=</span> <span class="token punctuation">{</span>
  topMouseDown<span class="token punctuation">:</span>   SimpleEventPlugin<span class="token punctuation">.</span>abstractEventTypes<span class="token punctuation">.</span>mouseDown<span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>在 <code>EnterLeaveEventPlugin.js</code> 中， <code>extractAbstractEvents</code> 方法返回了 <code>[leave, enter]</code> 的 AbstractEvent 实例化，并且调用 <code>EventPropagators.accumulateEnterLeaveDispatches(leave, enter, fromID, toID);</code> 进行派发。</p> <p><code>EventPropagators.js</code> 相关的方法稍后做解读。</p> <p>那么在之前调用 <code>executeDispatchesAndRelease</code> 函数时，执行相应函数涉及到的函数如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// event/EventPluginUtils.js</span>
<span class="token keyword">function</span> <span class="token function">executeDispatch</span><span class="token punctuation">(</span><span class="token parameter">abstractEvent<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> domID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// forEachEventDispatch 函数中对应的 cb(abstractEvent, dispatchListeners, dispatchIDs)</span>
  <span class="token function">listener</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">,</span> domID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">executeDispatchesInOrder</span><span class="token punctuation">(</span><span class="token parameter">abstractEvent<span class="token punctuation">,</span> executeDispatch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">forEachEventDispatch</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">,</span> executeDispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  abstractEvent<span class="token punctuation">.</span>_dispatchListeners <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  abstractEvent<span class="token punctuation">.</span>_dispatchIDs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">forEachEventDispatch</span><span class="token punctuation">(</span><span class="token parameter">abstractEvent<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在初始化的时候，这两个内容都是被置为 null 的</span>
  <span class="token comment">// 他们都在 EventPropagators 被赋值</span>
  <span class="token comment">// 若存在的情况下，这就是你在元素上定义的事件回调及对应的 ID</span>
  <span class="token keyword">var</span> dispatchListeners <span class="token operator">=</span> abstractEvent<span class="token punctuation">.</span>_dispatchListeners<span class="token punctuation">;</span>
  <span class="token keyword">var</span> dispatchIDs <span class="token operator">=</span> abstractEvent<span class="token punctuation">.</span>_dispatchIDs<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>dispatchListeners<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>
      i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      i <span class="token operator">&lt;</span> dispatchListeners<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>abstractEvent<span class="token punctuation">.</span>isPropagationStopped<span class="token punctuation">;</span>
      i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Listeners and IDs are two parallel arrays that are always in sync.</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">,</span> dispatchListeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dispatchIDs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatchListeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">,</span> dispatchListeners<span class="token punctuation">,</span> dispatchIDs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="抽象事件-abstractevent"><a href="#抽象事件-abstractevent" aria-hidden="true" class="header-anchor">#</a> 抽象事件 AbstractEvent</h3> <p>大家对 <code>AbstractEvent</code> 的属性有些疑问，因为刚刚在提到的时候并没有提到 <code>AbstractEvent</code> 的实现。那么接下来解释下，这样能把全部都串联起来：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// event/AbstractEvent.js</span>
<span class="token keyword">var</span> <span class="token constant">MAX_POOL_SIZE</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">AbstractEvent</span><span class="token punctuation">(</span>
    abstractEventType<span class="token punctuation">,</span>
    abstractTargetID<span class="token punctuation">,</span>  <span class="token comment">// Allows the abstract target to differ from native.</span>
    originatingTopLevelEventType<span class="token punctuation">,</span>
    nativeEvent<span class="token punctuation">,</span>
    data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// SimpleEventPlugin.abstractEventTypes.click, .reactRoot[0]', 'topClick', event, data</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> abstractEventType<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>abstractTargetID <span class="token operator">=</span> abstractTargetID <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>originatingTopLevelEventType <span class="token operator">=</span> originatingTopLevelEventType<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>nativeEvent <span class="token operator">=</span> nativeEvent<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> nativeEvent <span class="token operator">&amp;&amp;</span> nativeEvent<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_dispatchListeners <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_dispatchIDs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>isPropagationStopped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

AbstractEvent<span class="token punctuation">.</span>poolSize <span class="token operator">=</span> <span class="token constant">MAX_POOL_SIZE</span><span class="token punctuation">;</span>

<span class="token class-name">AbstractEvent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">destructor</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_dispatchListeners <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_dispatchIDs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

PooledClass<span class="token punctuation">.</span><span class="token function">addPoolingTo</span><span class="token punctuation">(</span>AbstractEvent<span class="token punctuation">,</span> PooledClass<span class="token punctuation">.</span>fiveArgumentPooler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="模拟捕获-冒泡（1）"><a href="#模拟捕获-冒泡（1）" aria-hidden="true" class="header-anchor">#</a> 模拟捕获/冒泡（1）</h3> <p>现在我们来看到刚刚忽略掉的 <code>EventPropagators.accumulateTwoPhaseDispatches</code> 和 <code>EventPropagators.accumulateEnterLeaveDispatches</code> 方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// event/EventPropagators.js</span>
<span class="token keyword">function</span> <span class="token function">accumulateTwoPhaseDispatches</span><span class="token punctuation">(</span><span class="token parameter">abstractEvents</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">forEachAccumulated</span><span class="token punctuation">(</span>abstractEvents<span class="token punctuation">,</span> accumulateTwoPhaseDispatchesSingle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">accumulateTwoPhaseDispatchesSingle</span><span class="token punctuation">(</span><span class="token parameter">abstractEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>abstractEvent <span class="token operator">&amp;&amp;</span> abstractEvent<span class="token punctuation">.</span>type<span class="token punctuation">.</span>phasedRegistrationNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获得 phasedRegistrationNames 对象</span>
    injection<span class="token punctuation">.</span>InstanceHandle<span class="token punctuation">.</span><span class="token function">traverseTwoPhase</span><span class="token punctuation">(</span>
      abstractEvent<span class="token punctuation">.</span>abstractTargetID<span class="token punctuation">,</span>
      accumulateDirectionalDispatches<span class="token punctuation">,</span>
      abstractEvent
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">accumulateEnterLeaveDispatches</span><span class="token punctuation">(</span><span class="token parameter">leave<span class="token punctuation">,</span> enter<span class="token punctuation">,</span> fromID<span class="token punctuation">,</span> toID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  injection<span class="token punctuation">.</span>InstanceHandle<span class="token punctuation">.</span><span class="token function">traverseEnterLeave</span><span class="token punctuation">(</span>
    fromID<span class="token punctuation">,</span>
    toID<span class="token punctuation">,</span>
    accumulateDispatches<span class="token punctuation">,</span>
    leave<span class="token punctuation">,</span>
    enter
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">listenerAtPhase</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> abstractEvent<span class="token punctuation">,</span> propagationPhase</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取对应的注册名称</span>
  <span class="token keyword">var</span> registrationName <span class="token operator">=</span>
    abstractEvent<span class="token punctuation">.</span>type<span class="token punctuation">.</span>phasedRegistrationNames<span class="token punctuation">[</span>propagationPhase<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 这个 getListener 函数需要看到 CallbackRegistry.js 相关的方法</span>
  <span class="token keyword">return</span> <span class="token function">getListener</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> registrationName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">accumulateDirectionalDispatches</span><span class="token punctuation">(</span><span class="token parameter">domID<span class="token punctuation">,</span> upwards<span class="token punctuation">,</span> abstractEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// domID = 当前 traverseParentPath 的 ID</span>
  <span class="token comment">// upwards = true / false</span>
  <span class="token keyword">var</span> phase <span class="token operator">=</span> upwards <span class="token operator">?</span> PropagationPhases<span class="token punctuation">.</span>bubbled <span class="token punctuation">:</span> PropagationPhases<span class="token punctuation">.</span>captured<span class="token punctuation">;</span>
  <span class="token comment">// 获得对应的 cb</span>
  <span class="token keyword">var</span> listener <span class="token operator">=</span> <span class="token function">listenerAtPhase</span><span class="token punctuation">(</span>domID<span class="token punctuation">,</span> abstractEvent<span class="token punctuation">,</span> phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果回调存在的情况下对 _dispatchListeners 和 _dispatchIDs 进行合并</span>
    <span class="token comment">// 本身不存在的情况下，返回新的 listener 和 domID</span>
    <span class="token comment">// 存在的情况下返回 listener[] 和 domID[]</span>
    abstractEvent<span class="token punctuation">.</span>_dispatchListeners <span class="token operator">=</span>
      <span class="token function">accumulate</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">.</span>_dispatchListeners<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    abstractEvent<span class="token punctuation">.</span>_dispatchIDs <span class="token operator">=</span> <span class="token function">accumulate</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">.</span>_dispatchIDs<span class="token punctuation">,</span> domID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 也是同样</span>
<span class="token keyword">function</span> <span class="token function">accumulateDispatches</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> ignoredDirection<span class="token punctuation">,</span> abstractEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>abstractEvent <span class="token operator">&amp;&amp;</span> abstractEvent<span class="token punctuation">.</span>type<span class="token punctuation">.</span>registrationName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> listener <span class="token operator">=</span> <span class="token function">getListener</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> abstractEvent<span class="token punctuation">.</span>type<span class="token punctuation">.</span>registrationName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      abstractEvent<span class="token punctuation">.</span>_dispatchListeners <span class="token operator">=</span>
        <span class="token function">accumulate</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">.</span>_dispatchListeners<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
      abstractEvent<span class="token punctuation">.</span>_dispatchIDs <span class="token operator">=</span> <span class="token function">accumulate</span><span class="token punctuation">(</span>abstractEvent<span class="token punctuation">.</span>_dispatchIDs<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h3 id="存储事件回调"><a href="#存储事件回调" aria-hidden="true" class="header-anchor">#</a> 存储事件回调</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// event/CallbackRegistry.js</span>
<span class="token comment">// 回调监听银行，用于存储各种 cb</span>
<span class="token keyword">var</span> listenerBank <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> CallbackRegistry <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 加入 cb</span>
  <span class="token function-variable function">putListener</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> registrationName<span class="token punctuation">,</span> listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bankForRegistrationName <span class="token operator">=</span>
      listenerBank<span class="token punctuation">[</span>registrationName<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>listenerBank<span class="token punctuation">[</span>registrationName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bankForRegistrationName<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> listener<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 获得 cb</span>
  <span class="token function-variable function">getListener</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> registrationName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bankForRegistrationName <span class="token operator">=</span> listenerBank<span class="token punctuation">[</span>registrationName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bankForRegistrationName <span class="token operator">&amp;&amp;</span> bankForRegistrationName<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 移除 cb</span>
  <span class="token function-variable function">deleteListener</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> registrationName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bankForRegistrationName <span class="token operator">=</span> listenerBank<span class="token punctuation">[</span>registrationName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bankForRegistrationName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> bankForRegistrationName<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 清空所有</span>
  <span class="token function-variable function">__purge</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listenerBank <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="模拟捕获-冒泡（2）"><a href="#模拟捕获-冒泡（2）" aria-hidden="true" class="header-anchor">#</a> 模拟捕获/冒泡（2）</h3> <p>这里所调用的 <code>injection.InstanceHandle</code> 下的方法其实就是 <code>ReactInstanceHandles</code> 的方法，回忆到在默认注入的时候，那么这里来看下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// core/ReactInstanceHandles.js</span>
<span class="token keyword">var</span> ReactInstanceHandles <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">traverseTwoPhase</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">targetID<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 直接看到 traverseParentPath 函数</span>
      <span class="token comment">// 比如:</span>
      <span class="token comment">// .reactRoot[0].[3].0</span>
      <span class="token comment">// 捕获阶段： .reactRoot[0] =&gt; .reactRoot[0].[3] =&gt; .reactRoot[0].[3].0</span>
      <span class="token comment">// 冒泡阶段： .reactRoot[0].[3].0 =&gt; .reactRoot[0].[3] =&gt; .reactRoot[0]</span>
      <span class="token comment">// 他里面是通过前后 '.' 来控制判断的</span>
      <span class="token comment">// 具体就是那行 for 循环代码以及相关的操作函数</span>
      <span class="token function">traverseParentPath</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> targetID<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">traverseParentPath</span><span class="token punctuation">(</span>targetID<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> cb<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">traverseEnterLeave</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">leaveID<span class="token punctuation">,</span> enterID<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> upArg<span class="token punctuation">,</span> downArg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取两个ID最近的共同祖先ID</span>
    <span class="token keyword">var</span> longestCommonID <span class="token operator">=</span> ReactInstanceHandles<span class="token punctuation">.</span><span class="token function">getFirstCommonAncestorID</span><span class="token punctuation">(</span>
      leaveID<span class="token punctuation">,</span>
      enterID
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>longestCommonID <span class="token operator">!==</span> leaveID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">traverseParentPath</span><span class="token punctuation">(</span>leaveID<span class="token punctuation">,</span> longestCommonID<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> upArg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>longestCommonID <span class="token operator">!==</span> enterID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">traverseParentPath</span><span class="token punctuation">(</span>longestCommonID<span class="token punctuation">,</span> enterID<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> downArg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 在两个ID之间遍历父路径（向上或向下）。ID不能相同，并且它们之间必须存在父路径。</span>
<span class="token comment">// 方法的作用因为比较抽象，我会举个例子在上面。</span>
<span class="token keyword">function</span> <span class="token function">traverseParentPath</span><span class="token punctuation">(</span><span class="token parameter">start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> skipFirst<span class="token punctuation">,</span> skipLast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  start <span class="token operator">=</span> start <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  stop <span class="token operator">=</span> stop <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    start <span class="token operator">!==</span> stop<span class="token punctuation">,</span>
    <span class="token string">'traverseParentPath(...): Cannot traverse from and to the same ID, `%s`.'</span><span class="token punctuation">,</span>
    start
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ancestorID <span class="token operator">=</span> ReactInstanceHandles<span class="token punctuation">.</span><span class="token function">getFirstCommonAncestorID</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> traverseUp <span class="token operator">=</span> ancestorID <span class="token operator">===</span> stop<span class="token punctuation">;</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    traverseUp <span class="token operator">||</span> ancestorID <span class="token operator">===</span> start<span class="token punctuation">,</span>
    <span class="token string">'traverseParentPath(%s, %s, ...): Cannot traverse from two IDs that do '</span> <span class="token operator">+</span>
    <span class="token string">'not have a parent path.'</span><span class="token punctuation">,</span>
    start<span class="token punctuation">,</span>
    stop
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Traverse from `start` to `stop` one depth at a time.</span>
  <span class="token keyword">var</span> depth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 通过 traverseUp 来控制是使用 parentID 函数还是 nextDescendantID 方法。</span>
  <span class="token comment">// 就是从前往后取或者是从后往前取</span>
  <span class="token keyword">var</span> traverse <span class="token operator">=</span> traverseUp <span class="token operator">?</span> parentID <span class="token punctuation">:</span> ReactInstanceHandles<span class="token punctuation">.</span>nextDescendantID<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> id <span class="token operator">=</span> start<span class="token punctuation">;</span> <span class="token comment">/* until break */</span><span class="token punctuation">;</span> id <span class="token operator">=</span> <span class="token function">traverse</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> stop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>skipFirst <span class="token operator">||</span> id <span class="token operator">!==</span> start<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>skipLast <span class="token operator">||</span> id <span class="token operator">!==</span> stop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> traverseUp<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> stop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Only break //after// visiting `stop`.</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span>
      depth<span class="token operator">++</span> <span class="token operator">&lt;</span> <span class="token constant">MAX_TREE_DEPTH</span><span class="token punctuation">,</span>
      <span class="token string">'traverseParentPath(%s, %s, ...): Detected an infinite loop while '</span> <span class="token operator">+</span>
      <span class="token string">'traversing the React DOM ID tree. This may be due to malformed IDs: %s'</span><span class="token punctuation">,</span>
      start<span class="token punctuation">,</span> stop
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>最后呢就是在 <code>ReactNativeComponent.js</code> 中 <code>_createOpenTagMarkup</code> 方法中的 <code>putListener</code> 函数，看过 <code>putListener</code> 函数就是用于存入回调函数的，在 <code>getListener</code> 获得则会去执行。</p> <p>那么到此为止，实现事件机制。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8baa1c18.js" defer></script><script src="/assets/js/2.c363b9ef.js" defer></script><script src="/assets/js/103.2d3829fa.js" defer></script>
  </body>
</html>
