<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器原理 | 地狱猫</title>
    <meta name="description" content="向前一小步文明一大步">
    
    
    <link rel="preload" href="/assets/css/0.styles.5b15de55.css" as="style"><link rel="preload" href="/assets/js/app.8baa1c18.js" as="script"><link rel="preload" href="/assets/js/2.c363b9ef.js" as="script"><link rel="preload" href="/assets/js/86.f97efcad.js" as="script"><link rel="prefetch" href="/assets/js/10.b82cb7bf.js"><link rel="prefetch" href="/assets/js/100.c8fd16ce.js"><link rel="prefetch" href="/assets/js/101.c65497a1.js"><link rel="prefetch" href="/assets/js/102.1c50acd0.js"><link rel="prefetch" href="/assets/js/103.2d3829fa.js"><link rel="prefetch" href="/assets/js/104.f6530161.js"><link rel="prefetch" href="/assets/js/105.e2d7d4ae.js"><link rel="prefetch" href="/assets/js/106.a9b6a793.js"><link rel="prefetch" href="/assets/js/107.9e673e79.js"><link rel="prefetch" href="/assets/js/108.ffd6b797.js"><link rel="prefetch" href="/assets/js/109.f3a087da.js"><link rel="prefetch" href="/assets/js/11.50040078.js"><link rel="prefetch" href="/assets/js/110.6637ef3a.js"><link rel="prefetch" href="/assets/js/111.d38fca98.js"><link rel="prefetch" href="/assets/js/112.b60db543.js"><link rel="prefetch" href="/assets/js/113.200a573a.js"><link rel="prefetch" href="/assets/js/114.d3c96553.js"><link rel="prefetch" href="/assets/js/115.6deda451.js"><link rel="prefetch" href="/assets/js/116.260f763f.js"><link rel="prefetch" href="/assets/js/117.72244e33.js"><link rel="prefetch" href="/assets/js/118.cb63b3a4.js"><link rel="prefetch" href="/assets/js/119.88a7979b.js"><link rel="prefetch" href="/assets/js/12.ee2aef2f.js"><link rel="prefetch" href="/assets/js/120.1e71300a.js"><link rel="prefetch" href="/assets/js/121.b9d5d01f.js"><link rel="prefetch" href="/assets/js/122.fa3a2b3c.js"><link rel="prefetch" href="/assets/js/123.18b52755.js"><link rel="prefetch" href="/assets/js/124.22dae44e.js"><link rel="prefetch" href="/assets/js/125.6f693785.js"><link rel="prefetch" href="/assets/js/126.9979d92e.js"><link rel="prefetch" href="/assets/js/127.97129415.js"><link rel="prefetch" href="/assets/js/128.201a3af5.js"><link rel="prefetch" href="/assets/js/129.02f6ced5.js"><link rel="prefetch" href="/assets/js/13.9ba3b7b3.js"><link rel="prefetch" href="/assets/js/130.a2809baf.js"><link rel="prefetch" href="/assets/js/14.8387646c.js"><link rel="prefetch" href="/assets/js/15.9053ef96.js"><link rel="prefetch" href="/assets/js/16.885fad55.js"><link rel="prefetch" href="/assets/js/17.3e595d76.js"><link rel="prefetch" href="/assets/js/18.d2db4c3a.js"><link rel="prefetch" href="/assets/js/19.693475f3.js"><link rel="prefetch" href="/assets/js/20.7657adef.js"><link rel="prefetch" href="/assets/js/21.9db66cb8.js"><link rel="prefetch" href="/assets/js/22.017b8ee6.js"><link rel="prefetch" href="/assets/js/23.e3d63843.js"><link rel="prefetch" href="/assets/js/24.778b9842.js"><link rel="prefetch" href="/assets/js/25.9db9c6a8.js"><link rel="prefetch" href="/assets/js/26.a1464114.js"><link rel="prefetch" href="/assets/js/27.005c669a.js"><link rel="prefetch" href="/assets/js/28.83ba67aa.js"><link rel="prefetch" href="/assets/js/29.3b5d9158.js"><link rel="prefetch" href="/assets/js/3.55fc7466.js"><link rel="prefetch" href="/assets/js/30.27602bf8.js"><link rel="prefetch" href="/assets/js/31.30b968a7.js"><link rel="prefetch" href="/assets/js/32.c5c32adc.js"><link rel="prefetch" href="/assets/js/33.28363357.js"><link rel="prefetch" href="/assets/js/34.d934db23.js"><link rel="prefetch" href="/assets/js/35.d317a407.js"><link rel="prefetch" href="/assets/js/36.c34064e0.js"><link rel="prefetch" href="/assets/js/37.d0122ae3.js"><link rel="prefetch" href="/assets/js/38.3897eeb2.js"><link rel="prefetch" href="/assets/js/39.fa564859.js"><link rel="prefetch" href="/assets/js/4.a18312b1.js"><link rel="prefetch" href="/assets/js/40.18195e4e.js"><link rel="prefetch" href="/assets/js/41.1e09a7ba.js"><link rel="prefetch" href="/assets/js/42.7005f709.js"><link rel="prefetch" href="/assets/js/43.80deb814.js"><link rel="prefetch" href="/assets/js/44.c464426d.js"><link rel="prefetch" href="/assets/js/45.b1d17d7a.js"><link rel="prefetch" href="/assets/js/46.e3a0a71a.js"><link rel="prefetch" href="/assets/js/47.5ca1b2a7.js"><link rel="prefetch" href="/assets/js/48.2c96008f.js"><link rel="prefetch" href="/assets/js/49.ce2015c8.js"><link rel="prefetch" href="/assets/js/5.98f0c28f.js"><link rel="prefetch" href="/assets/js/50.69399a6d.js"><link rel="prefetch" href="/assets/js/51.6fe3216a.js"><link rel="prefetch" href="/assets/js/52.ce3e04da.js"><link rel="prefetch" href="/assets/js/53.66c0b531.js"><link rel="prefetch" href="/assets/js/54.e7a6dc85.js"><link rel="prefetch" href="/assets/js/55.67fd71ea.js"><link rel="prefetch" href="/assets/js/56.5805ea45.js"><link rel="prefetch" href="/assets/js/57.51edec73.js"><link rel="prefetch" href="/assets/js/58.dadcc0bf.js"><link rel="prefetch" href="/assets/js/59.f2ee4962.js"><link rel="prefetch" href="/assets/js/6.9d21f84a.js"><link rel="prefetch" href="/assets/js/60.8653fa8c.js"><link rel="prefetch" href="/assets/js/61.8f632334.js"><link rel="prefetch" href="/assets/js/62.ebc3d94b.js"><link rel="prefetch" href="/assets/js/63.734529fa.js"><link rel="prefetch" href="/assets/js/64.dc7d9ed8.js"><link rel="prefetch" href="/assets/js/65.3a073543.js"><link rel="prefetch" href="/assets/js/66.0766faee.js"><link rel="prefetch" href="/assets/js/67.ae00c912.js"><link rel="prefetch" href="/assets/js/68.5309c10b.js"><link rel="prefetch" href="/assets/js/69.d6e79a9b.js"><link rel="prefetch" href="/assets/js/7.c1707ee3.js"><link rel="prefetch" href="/assets/js/70.09c653a2.js"><link rel="prefetch" href="/assets/js/71.0791c1ec.js"><link rel="prefetch" href="/assets/js/72.7fbb5123.js"><link rel="prefetch" href="/assets/js/73.264558f2.js"><link rel="prefetch" href="/assets/js/74.24fb5137.js"><link rel="prefetch" href="/assets/js/75.cb924dd1.js"><link rel="prefetch" href="/assets/js/76.5be6dad8.js"><link rel="prefetch" href="/assets/js/77.d293358a.js"><link rel="prefetch" href="/assets/js/78.a5ba6da1.js"><link rel="prefetch" href="/assets/js/79.7fbb902d.js"><link rel="prefetch" href="/assets/js/8.88da2a38.js"><link rel="prefetch" href="/assets/js/80.265fcf49.js"><link rel="prefetch" href="/assets/js/81.5cbf3d53.js"><link rel="prefetch" href="/assets/js/82.61e1168d.js"><link rel="prefetch" href="/assets/js/83.c957da9f.js"><link rel="prefetch" href="/assets/js/84.3363c030.js"><link rel="prefetch" href="/assets/js/85.c1802988.js"><link rel="prefetch" href="/assets/js/87.a4258d3f.js"><link rel="prefetch" href="/assets/js/88.310decb4.js"><link rel="prefetch" href="/assets/js/89.673a6248.js"><link rel="prefetch" href="/assets/js/9.8f0f74e4.js"><link rel="prefetch" href="/assets/js/90.4ae7e5ea.js"><link rel="prefetch" href="/assets/js/91.75feaf6e.js"><link rel="prefetch" href="/assets/js/92.059ca332.js"><link rel="prefetch" href="/assets/js/93.439369e5.js"><link rel="prefetch" href="/assets/js/94.36ddb701.js"><link rel="prefetch" href="/assets/js/95.642311f2.js"><link rel="prefetch" href="/assets/js/96.1ecb484a.js"><link rel="prefetch" href="/assets/js/97.bcdbc3fb.js"><link rel="prefetch" href="/assets/js/98.d4f0cc28.js"><link rel="prefetch" href="/assets/js/99.a7b2f6b6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5b15de55.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">地狱猫</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/webpack/基础篇.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/react/" class="nav-link">react</a></div><div class="nav-item"><a href="/css/规范.html" class="nav-link">css</a></div><div class="nav-item"><a href="/day/a标签href不能下载图片.html" class="nav-link">日常</a></div><div class="nav-item"><a href="/tool/emoij美化你的commitlog.html" class="nav-link">工具</a></div><div class="nav-item"><a href="/accumulate/jserror.html" class="nav-link">积累</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/datastruct/" class="nav-link">数据结构</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/webpack/基础篇.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/react/" class="nav-link">react</a></div><div class="nav-item"><a href="/css/规范.html" class="nav-link">css</a></div><div class="nav-item"><a href="/day/a标签href不能下载图片.html" class="nav-link">日常</a></div><div class="nav-item"><a href="/tool/emoij美化你的commitlog.html" class="nav-link">工具</a></div><div class="nav-item"><a href="/accumulate/jserror.html" class="nav-link">积累</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/datastruct/" class="nav-link">数据结构</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/exam/浏览器原理.html" class="active sidebar-link">浏览器原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/exam/浏览器原理.html#浏览器原理" class="sidebar-link">浏览器原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/exam/浏览器原理.html#前置知识—进程和线程" class="sidebar-link">前置知识—进程和线程</a></li><li class="sidebar-sub-header"><a href="/exam/浏览器原理.html#浏览器架构-原理篇" class="sidebar-link">浏览器架构-原理篇</a></li><li class="sidebar-sub-header"><a href="/exam/浏览器原理.html#浏览器架构-实践篇" class="sidebar-link">浏览器架构-实践篇</a></li><li class="sidebar-sub-header"><a href="/exam/浏览器原理.html#在浏览器地址栏中输入url到页面展现的短短几秒内浏览器究竟做了什么？" class="sidebar-link">在浏览器地址栏中输入url到页面展现的短短几秒内浏览器究竟做了什么？</a></li><li class="sidebar-sub-header"><a href="/exam/浏览器原理.html#浏览器内核-流程概况" class="sidebar-link">浏览器内核-流程概况</a></li><li class="sidebar-sub-header"><a href="/exam/浏览器原理.html#【问题1】为什么连接的时候是三次握手，关闭的时候却是四次握手？" class="sidebar-link">【问题1】为什么连接的时候是三次握手，关闭的时候却是四次握手？</a></li><li class="sidebar-sub-header"><a href="/exam/浏览器原理.html#【问题2】为什么time-wait状态需要经过2msl-最大报文段生存时间-才能返回到close状态？" class="sidebar-link">【问题2】为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？</a></li><li class="sidebar-sub-header"><a href="/exam/浏览器原理.html#【问题3】为什么不能用两次握手进行连接？" class="sidebar-link">【问题3】为什么不能用两次握手进行连接？</a></li><li class="sidebar-sub-header"><a href="/exam/浏览器原理.html#【问题4】如果已经建立了连接，但是客户端突然出现故障了怎么办？" class="sidebar-link">【问题4】如果已经建立了连接，但是客户端突然出现故障了怎么办？</a></li></ul></li></ul></li><li><a href="/exam/js.html" class="sidebar-link">js</a></li><li><a href="/exam/Web安全总结.html" class="sidebar-link">Web安全总结</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="浏览器原理"><a href="#浏览器原理" aria-hidden="true" class="header-anchor">#</a> 浏览器原理</h2> <blockquote><blockquote><p><a href="https://juejin.im/post/5c6d3e026fb9a04a0d576f98" target="_blank" rel="noopener noreferrer">传送门<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://segmentfault.com/a/1190000020372713?utm_source=tag-newest" target="_blank" rel="noopener noreferrer">春松们<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote></blockquote> <ul><li><a href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E2%80%94%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B">前置知识—进程和线程</a></li> <li><a href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%9E%B6%E6%9E%84-%E5%8E%9F%E7%90%86%E7%AF%87">浏览器架构-原理篇</a></li> <li><a href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%9E%B6%E6%9E%84-%E5%AE%9E%E8%B7%B5%E7%AF%87">浏览器架构-实践篇</a></li> <li><a href="#%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E5%9C%B0%E5%9D%80%E6%A0%8F%E4%B8%AD%E8%BE%93%E5%85%A5url%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%8E%B0%E7%9A%84%E7%9F%AD%E7%9F%AD%E5%87%A0%E7%A7%92%E5%86%85%E6%B5%8F%E8%A7%88%E5%99%A8%E7%A9%B6%E7%AB%9F%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F">在浏览器地址栏中输入url到页面展现的短短几秒内浏览器究竟做了什么？</a></li> <li><a href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%86%85%E6%A0%B8-%E6%B5%81%E7%A8%8B%E6%A6%82%E5%86%B5">浏览器内核-流程概况</a></li> <li><a href="#window.opener%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98">window.opener安全问题</a></li> <li><a href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E">文件上传漏洞</a></li></ul> <h3 id="前置知识—进程和线程"><a href="#前置知识—进程和线程" aria-hidden="true" class="header-anchor">#</a> 前置知识—进程和线程</h3> <h4 id="进程（任务）"><a href="#进程（任务）" aria-hidden="true" class="header-anchor">#</a> 进程（任务）</h4> <ul><li>An image （与程序相关联的可执行机器代码）</li> <li>内存</li> <li>Operating system descriptors分配的资源</li> <li>安全属性</li> <li>CPU的上下文</li></ul> <p>因为安全性和可靠性，现代操作系统不允许进程之间直接通讯，采用了一种严格的通讯方法叫做 IPC （Inter-process communication）。</p> <p>多任务的操作系统存在多个进程同时执行，单核CPU一次性只能执行一个进程，CPU进行切换任务，不必等待上一个任务执行结束。</p> <p>通常，程序中的主程序只有单个进程和多个子进程。</p> <h4 id="线程"><a href="#线程" aria-hidden="true" class="header-anchor">#</a> 线程</h4> <ul><li>线程是最小的一系列程序指令。</li> <li>线程是进程中的一个部分。</li> <li>多线程可以存在一个进程中，并发执行和共享资源。</li></ul> <h4 id="进程-vs-线程"><a href="#进程-vs-线程" aria-hidden="true" class="header-anchor">#</a> 进程 vs 线程</h4> <ul><li>进程之间是独立的，而线程是进程的子集</li> <li>进程中状态信息比线程多，然而一个进程中的多线程共享着和进程一样的状态信息</li> <li>进程有独立的地址空间，线程只是分享进行的地址空间</li> <li>进程通讯依据系统提供的IPC方法</li> <li>上下文切换而言，线程切换比进程快</li></ul> <h3 id="浏览器架构-原理篇"><a href="#浏览器架构-原理篇" aria-hidden="true" class="header-anchor">#</a> 浏览器架构-原理篇</h3> <p>当代现有的浏览器主要由<code>用户界面（The user interface）</code>、<code>浏览器引擎（The browser engine）</code>、<code>呈现引擎（The rendering engine）</code>、<code>网络（Networking）</code>、<code>JavasScript 解释器（JavaScript interpreter）</code>、<code>用户界面后端（UI backend）</code>、<code>数据存储组成（Data storage）</code>。</p> <p>而这些组件的功能如下：</p> <ol><li>用户界面 - 包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面。</li> <li>浏览器引擎 - 在用户界面和呈现引擎之间传送指令。</li> <li>渲染引擎 - 负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容，并将解析后的内容显示在屏幕上。</li> <li>网络 - 用于网络调用，比如 HTTP 请求。其接口与平台无关，并为所有平台提供底层实现。</li> <li>用户界面后端 - 用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法。</li> <li>JavaScript 解释器。用于解析和执行 JavaScript 代码。</li> <li>数据存储。这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie。新的 HTML 规范 (HTML5) 定义了“网络数据库”，这是一个完整（但是轻便）的浏览器内数据库。</li></ol> <h3 id="浏览器架构-实践篇"><a href="#浏览器架构-实践篇" aria-hidden="true" class="header-anchor">#</a> 浏览器架构-实践篇</h3> <p>chrome有哪些主要进程吧。</p> <ul><li>Browser Process：浏览器的主进程（负责协调、主控），只有一个。
<ul><li>负责包括地址栏，书签栏，前进后退按钮等部分的工作；</li> <li>负责各个页面的管理，创建和销毁其他进程；</li> <li>将Renderer进程得到的内存中的Bitmap，绘制到用户界面上；</li> <li>负责处理浏览器的一些不可见的底层操作，比如网络请求和文件访问；</li></ul></li> <li>Renderer Process：默认每个Tab页面一个进程，互不影响。
<ul><li>页面渲染，脚本执行，事件处理等</li></ul></li> <li>Plugin Process：每种类型的插件对应一个进程，仅当使用该插件时才创建</li> <li>GPU Process：最多一个，用于3D绘制等</li></ul> <h3 id="在浏览器地址栏中输入url到页面展现的短短几秒内浏览器究竟做了什么？"><a href="#在浏览器地址栏中输入url到页面展现的短短几秒内浏览器究竟做了什么？" aria-hidden="true" class="header-anchor">#</a> 在浏览器地址栏中输入url到页面展现的短短几秒内浏览器究竟做了什么？</h3> <p>整个浏览器中的主进程是Browser Process，而进程中会有不同的线程，所以该进程将不同的任务交给不同的线程处理：</p> <ul><li>UI thread：控制浏览器上的按钮及输入框</li> <li>network thread：处理网络请求，从网上获取数据</li> <li>storage thread：控制文件等的访问</li></ul> <p>这样的操作在浏览器看来可以分为以下几步：</p> <ol><li>处理输入
UI thread 需要判断用户输入的是 URL 还是 query。</li> <li>开始导航
当用户点击回车，UI thread 通知 Network thread 获取网页内容，同时控制 tab 上的 spinner 展示（逆时针），表示正在请求页面。</li></ol> <p>Network thread 会按照顺序查询 DNS，随后为请求简历 TLS （傳輸層安全性協定：Transport Layer Security）连接。</p> <p>如果 Network thread 接收到了重定向的请求头如 301，Network thread 会通知 UI thread： 服务器要求重定向了，随后，另一个 URL 请求会被触发。</p> <ol start="3"><li>读取响应
当请求响应回来，Network thread 会依据文档的 Content-type 及 MIME Type sniffing 判断响应内容的格式。</li></ol> <p>如果响应内容的格式是 HTML，下一步将会把对应的文档交给 Renderer process，如果是 zip文件或是其它文件，会把相关数据传输给下载管理器。</p> <p>Safe Browsing 检查也会在此时触发，如果域名或是请求内容匹配到已知的恶意站点，Network thread 会展示一个警告页。此外 CORB 检测也会触发确保敏感数据不会被传递 Renderer process。</p> <ol start="4"><li>查看渲染进程
当上述检查完成，Network thread 确信浏览器可以导航到请求的网页，Network thread 会通知 UI thread 数据已经准备好了，UI thread 会查找到一个 Renderer process进行网页的渲染。</li></ol> <blockquote><p>由于网络请求获取响应需要时间，这里其实还存在着一个加速方案。当 UI thread 发送 URL 请求给 network thread 时，浏览器其实已经知道了将要导航到那个站点。UI thread 会并行的预先查找和启动一个渲染进程，如果一切正常，当 network thread 接收到数据时，渲染进程已经准备就绪了，但是如果遇到重定向，准备好的渲染进程也许就不可用了，这时候就需要重启一个新的渲染进程。</p></blockquote> <ol start="5"><li><p>确认导航
完成了上述过程，数据和渲染进行都是准备状态，Browser Process 会给 Renderer Process 发送 IPC 消息来确认导航，一旦 Browser Process 收到 renderer process 的渲染确认消息，导航过程结束，页面加载过程开始（ UI thread 通知 tab 的 spinner 展示（顺时针））。
此时，地址栏会更新，展示出新页面的网页信息。history tab 会更新，可通过返回键返回导航来的页面，为了让关闭 tab 或者窗口后便于恢复，这些信息会存放在硬盘中。</p></li> <li><p>额外的步骤
导航被确认，Renderer Processs 会使用相关的资源将页面渲染出来。当 Renderer Process 渲染结束（即触发所以页面的onload事件），会发送 IPC 消息到 Browser Process，然后 UI thread 停止展示 tab 中的 spinner。</p></li></ol> <h3 id="浏览器内核-流程概况"><a href="#浏览器内核-流程概况" aria-hidden="true" class="header-anchor">#</a> 浏览器内核-流程概况</h3> <blockquote><p>负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容，并将解析后的内容显示在屏幕上。</p></blockquote> <p>从定义中得出，其主要核心作用是将请求内容显示在浏览器的窗口中。而我们知道请求内容的种类较多，但是渲染引擎默认展示是 HTML 文档、XML 文档和图片，再有插件支持的情况下方可支持其他的资源，如 pdf等类。</p> <h4 id="主流程"><a href="#主流程" aria-hidden="true" class="header-anchor">#</a> 主流程</h4> <p>起先将请求的内容转化为 8Kb 的 chunks，之后开始解析 HTML 文档构建 DOM 树 -&gt;解析样式结合DOM 树构建 render tree -&gt; 布局（layout） -&gt; 绘制（painting）。</p> <ul><li><code>render tree</code>：每一个节点都是一个带有可视化样式和尺寸信息的矩形，节点按照正确的顺序去排列展示的。</li> <li><code>layout</code>：该部分目的就是计算出每一个节点的在屏幕上正确的位置。</li> <li><code>painting</code>：遍历 render tree，在用户界面后端（UI Backend layer）的帮助下绘制每一个节点。</li></ul> <p>整个流程是一个逐渐的过程，为了更好的用户体验，需要尽快的展示内容，所以在浏览器不会等所有的HTML解析完，才开始构建和布局 render tree，这是同步线性进行的流程。这就说明内容会在解析和展示的同时，有其余内容还在网络处理中。</p> <h3 id="【问题1】为什么连接的时候是三次握手，关闭的时候却是四次握手？"><a href="#【问题1】为什么连接的时候是三次握手，关闭的时候却是四次握手？" aria-hidden="true" class="header-anchor">#</a> 【问题1】为什么连接的时候是三次握手，关闭的时候却是四次握手？</h3> <pre><code>答：因为当Server端收到Client端的SYN连接请求报文后，可以直接发送SYN+ACK报文。

其中ACK报文是用来应答的，SYN报文是用来同步的。

但是关闭连接时，当Server端收到FIN报文时，很可能并不会立即关闭SOCKET，

所以只能先回复一个ACK报文，告诉Client端，&quot;你发的FIN报文我收到了&quot;。

只有等到我Server端所有的报文都发送完了，我才能发送FIN报文，因此不能一起发送。

故需要四步握手
</code></pre> <h3 id="【问题2】为什么time-wait状态需要经过2msl-最大报文段生存时间-才能返回到close状态？"><a href="#【问题2】为什么time-wait状态需要经过2msl-最大报文段生存时间-才能返回到close状态？" aria-hidden="true" class="header-anchor">#</a> 【问题2】为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？</h3> <pre><code>答：虽然按道理，四个报文都发送完毕，我们可以直接进入CLOSE状态了，但是我们必须假象网络是不可靠的，

有可以最后一个ACK丢失。所以TIME_WAIT状态就是用来重发可能丢失的ACK报文。

在Client发送出最后的ACK回复，但该ACK可能丢失。Server如果没有收到ACK，将不断重复发送FIN片段。

所以Client不能立即关闭，它必须确认Server接收到了该ACK。Client会在发送出ACK之后进入到TIME_WAIT状态。

Client会设置一个计时器，等待2MSL的时间。如果在该时间内再次收到FIN，那么Client会重发ACK并再次等待2MSL。

所谓的2MSL是两倍的MSL(Maximum Segment Lifetime)。MSL指一个片段在网络中最大的存活时间，

2MSL就是一个发送和一个回复所需的最大时间。如果直到2MSL，Client都没有再次收到FIN，

那么Client推断ACK已经被成功接收，则结束TCP连接。
</code></pre> <h3 id="【问题3】为什么不能用两次握手进行连接？"><a href="#【问题3】为什么不能用两次握手进行连接？" aria-hidden="true" class="header-anchor">#</a> 【问题3】为什么不能用两次握手进行连接？</h3> <pre><code>答：3次握手完成两个重要的功能，既要双方做好发送数据的准备工作(双方都知道彼此已准备好)，

也要允许双方就初始序列号进行协商，这个序列号在握手过程中被发送和确认。

现在把三次握手改成仅需要两次握手，死锁是可能发生的。

作为例子，考虑计算机S和C之间的通信，假定C给S发送一个连接请求分组，S收到了这个分组，

并发 送了确认应答分组。按照两次握手的协定，S认为连接已经成功地建立了，可以开始发送数据分组。

可是，C在S的应答分组在传输中被丢失的情况下，将不知道S 是否已准备好，不知道S建立什么样的序列号，

C甚至怀疑S是否收到自己的连接请求分组。在这种情况下，C认为连接还未建立成功，将忽略S发来的任何数据分组，

只等待连接确认应答分组。而S在发出的分组超时后，重复发送同样的分组。这样就形成了死锁。
</code></pre> <h3 id="【问题4】如果已经建立了连接，但是客户端突然出现故障了怎么办？"><a href="#【问题4】如果已经建立了连接，但是客户端突然出现故障了怎么办？" aria-hidden="true" class="header-anchor">#</a> 【问题4】如果已经建立了连接，但是客户端突然出现故障了怎么办？</h3> <pre><code>TCP还设有一个保活计时器，显然，客户端如果出现故障，服务器不能一直等下去，白白浪费资源。

服务器每收到一次客户端的请求后都会重新复位这个计时器，时间通常是设置为2小时，

若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒钟发送一次。

若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。
</code></pre></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/exam/js.html">js</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8baa1c18.js" defer></script><script src="/assets/js/2.c363b9ef.js" defer></script><script src="/assets/js/86.f97efcad.js" defer></script>
  </body>
</html>
